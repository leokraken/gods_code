<?xml version="1.0" encoding="UTF-8"?>
<beans:beans
	xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:int-jms="http://www.springframework.org/schema/integration/jms"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:beans="http://www.springframework.org/schema/beans"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:int-stream="http://www.springframework.org/schema/integration/stream"
	xmlns:int-ws="http://www.springframework.org/schema/integration/ws"
	xmlns:int-jdbc="http://www.springframework.org/schema/integration/jdbc"
	xmlns:jdbc="http://www.springframework.org/schema/jdbc"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/context
		http://www.springframework.org/schema/context/spring-context.xsd
		http://www.springframework.org/schema/integration
		http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/integration/jms
		http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
		http://www.springframework.org/schema/integration/stream
		http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd
		http://www.springframework.org/schema/integration/ws
    	http://www.springframework.org/schema/integration/ws/spring-integration-ws.xsd
    	http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd
    	http://www.springframework.org/schema/integration/jdbc http://www.springframework.org/schema/integration/jdbc/spring-integration-jdbc.xsd">


	
	<beans:bean id="connectionFactory" class="org.springframework.jms.connection.CachingConnectionFactory">
		<beans:property name="targetConnectionFactory">
			<beans:bean class="org.apache.activemq.ActiveMQConnectionFactory">				
				<beans:property name="brokerURL" value="tcp://localhost:61616"/>
			</beans:bean>
		</beans:property>
		<beans:property name="sessionCacheSize" value="10"/>
		<beans:property name="cacheProducers" value="false"/>
	</beans:bean>

	<beans:bean id="bankQueue" class="org.apache.activemq.command.ActiveMQQueue">
		<beans:constructor-arg value="bankQueue"/>
	</beans:bean>	 
	 
	<int:annotation-config/>	

	<context:component-scan base-package="middleware.componentes"/>
			
	<!-- TEST.queue es el nombre de la cola JMS que usa el banco para mandar los msj -->
	<int-jms:inbound-channel-adapter id="jmsIn" destination="bankQueue" channel="jmsChannel">
	    <int:poller fixed-rate="1000"/>
	</int-jms:inbound-channel-adapter>	

	<!-- Definicion de canales. -->


	<!-- TODO: decidir si es un direct channel o un executor channel.
		Como esta ahora es un executor. La idea es que el executor 
		no bloquea al que envia el mensaje, comparado con el direct channel (por defecto)
		El executor tiene varios tipos tambien.. pool, executor, no se que mas.
	 -->
	<int:channel id="jmsChannel">
		<int:dispatcher task-executor="pool"/>
	</int:channel>

	<int:channel id="recipentListChannel" datatype="middleware.clases.datatypes.TransactionStatus"/>

	<int:publish-subscribe-channel id="invalidMessageChannel"/>
	
	
	
	
	<!--  -->
	
	<!-- For ws aggregator -->
	
	<int:channel id="router-aggregator" datatype="middleware.clases.datatypes.TransactionStatus"/>
	<int:channel id="aggregator-channel" datatype="middleware.clases.datatypes.Transactions"/>
	
	

	<int:aggregator id="TransactionAggregator"
		input-channel="router-aggregator" output-channel="aggregator-channel"
		method="addTransaction" ref="aggregatorsource"
		release-strategy="aggregatorsource"
		release-strategy-method="releaseChecker"
		expire-groups-upon-completion="true"
		correlation-strategy-expression="1">
	</int:aggregator>

	<beans:bean id="aggregatorsource" class="middleware.componentes.TransactionAggregator"/>	

	<int:router
		id="Router"
		input-channel="recipentListChannel" 
		method="resolveTransaction">
		<beans:bean class="middleware.componentes.RecipentList"/>
	</int:router>
	
	<!-- <int-ws:outbound-gateway id="ws-outbound"
    	request-channel="aggregator-channel"
        uri="http://localhost:8080/ACMETransactions/transactions"/> -->
	
	
 
	<int-ws:outbound-gateway id="ws-out"
		request-channel="aggregator-channel"
		uri="http://localhost:8080/ACMETransactions/transactions"
		reply-channel="ws-channel-out" marshaller="Marshaller"
		unmarshaller="Marshaller">
	</int-ws:outbound-gateway>

	<beans:bean id="Marshaller"
		class="middleware.componentes.MarshallerWS" />

	<int:channel id="ws-channel-out"></int:channel>
	

	<int:logging-channel-adapter id="log-ws" channel="ws-channel-out"
		level="TRACE">
	</int:logging-channel-adapter>
	
	<int:service-activator input-channel="ws-channel-out"
		ref="ws-log-error"
		method="LogInvalidMessageWS">
	</int:service-activator>
	
	<beans:bean id="ws-log-error" class="middleware.componentes.InvalidMessageHandler"/>	
	
	<int:channel id="pruebaJDBC-channel" datatype="middleware.clases.datatypes.TransactionBD"/>
	
	<int:channel id="transformJDBC-channel" datatype="middleware.clases.datatypes.TransactionStatus"/>
	
	<int:transformer id="transformer" ref="transformerBean" output-channel="pruebaJDBC-channel" 
	input-channel="transformJDBC-channel" method="transform"></int:transformer>
	
	<beans:bean id="transformerBean" class="middleware.componentes.Transformador"></beans:bean>
	
	<int-jdbc:outbound-channel-adapter
    query="insert into middleware.transactions (id,datetime,transaction_type,
    commerce_code,commerce_name,card_number,card_type,currency_code,amount) 
    values (:payload.Id,:payload.Fecha,'D',:payload.CodigoComercio,:payload.NombreComercio,
    :payload.NumeroTarjeta,:payload.TipoTarjeta,:payload.CodigoMoneda,:payload.Monto)"
    data-source="dataSource"
    channel="pruebaJDBC-channel"/>
    
    <beans:bean id="dataSource" class="middleware.componentes.MDataSource">
	</beans:bean>
	
</beans:beans>
